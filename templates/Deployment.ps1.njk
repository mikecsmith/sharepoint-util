{% from 'Macros.html' import ProvisionSubSite, AddContentTypeToPagesLibrary, CustomCommand,Command,SetListDefaultContentType,AddPublishingPage,SetPublishingPageFields %}

. "{{getFilePath('functions.ps1')}}"

$spHost = "{{getAttr(template,'spHost','host')|default(spHost)}}";
{% set serverRelativeUrl = "/sites/" + getAttr(template,'url') %}
$spGlobalSiteServerRelativeUrl = "sites/{{getAttr(template,'url')|default(url)}}";
$siteUrl = ($spHost + $spGlobalSiteServerRelativeUrl);

$title = "Actions"
$message = "What would you like to do?"

Write-Log "Running Fields and Content Types initialisation script"
Confirm-Continue -message "Deploy content types and fields to $siteUrl. Press y to continue"

Write-Log "Connecting to $siteUrl"

{% for command in getAttr(template,'preConnectCommands') %}
    
    {{Command(command)}}

{% endfor %}

Connect-PnPOnline -Url $siteUrl

{% for command in getAttr(template,'postConnectCommands') %}
    
    {{Command(command)}}

{% endfor %}

{% if getAttr(template,'setSiteCollectionTermGroupName') and getAttr(template,'siteCollectionGroupName') %}
Set-SiteCollectionTermGroupName "{{getAttr(template,'siteCollectionGroupName')}}"
{% endif %}

Write-Log "Provisioning Fields and Content Types"

Set-PnPTraceLog -On -Level Debug

{% for command in getAttr(template,'preProvisiongCommands') %}
    
{{Command(command)}}

{% endfor %}

Write-Log "Applying SiteCollection Provisioning..."

Apply-PnPProvisioningTemplate -Path "{{getFilePath('sitecollection-'+getAttr(template,'id')+'-'+postfix+'.xml')}}"

{% for ct in getAttr(template,'pagesLibraryContentTypes','pagesLibraryContentTypes') %}
Add-PnPContentTypeToList -List "Pages" -ContentType "{{ct}}"  
{% endfor %}

{% if getAttr(template,'defaultPagesContentType','pagesLibraryDefaultContentType','pagesContentType') %}
Set-PnPDefaultContentTypeToList -List "Pages" -ContentType "{{getAttr(template,'defaultPagesContentType','pagesLibraryDefaultContentType','pagesContentType')}}"
{% endif %}

{% if hasAttr(template,'pagesFieldsSettings','pagesFieldSettings') %}
    $dict = @{}
    {% for fieldName,fieldSettings in getAttr(template,'pagesFieldsSettings','pagesFieldSettings') %}
        {% for settingKey, settingValue in fieldSettings %}
            {% if settingKey == 'indexed' or settingKey == 'Indexed' %}
            $dict["Indexed"] = {% if settingValue %}$true{% else %}$false {% endif %}

            {% elif settingKey == 'enforceUniqueValues' or settingKey == 'unique' or settingKey == 'EnforceUniqueValues' %}

            $dict["EnforceUniqueValues"] = {% if settingValue %}$true{% else %}$false {% endif %}

            {% elif settingKey == 'required' or settingKey == 'Required' %}

            $dict["Required"] = {% if settingValue %}$true{% else %}$false {% endif %}

            {% else %} 
            $dict["{{vkey}}"] = {{getPowershellValue(vvalue)}}

            {% endif %}
        {% endfor %}

        Set-PnPField -Identity "{{fieldName}}" -List "Pages" -Values $dict   

    {% endfor %}
{% endif %}

{% for list in getAttr(template,'lists') %}
    {% if hasAttr(list,'readSecurity') or hasAttr(list,'writeSecurity') %}
    $list = Get-PnPList -Identity "{{getAttr(list,'title')}}" -Includes ReadSecurity,WriteSecurity
    if ($list -ne $null){
        {% if hasAttr(list,'readSecurity') %}
        $list.ReadSecurity = {{getAttr(list,'readSecurity')}}
        {% endif %}
        {% if hasAttr(list,'writeSecurity') %}
        $list.WriteSecurity = {{getAttr(list,'writeSecurity')|default(2)}}
        {% endif %}
        $list.Update() 
        $list.Context.ExecuteQuery() 
    }
    {% endif %}
    {% if hasAttr(list,'fieldsSettings','fieldSettings') %}
        $dict = @{}
        {% for fieldName,fieldSettings in getAttr(list,'pagesFieldsSettings','pagesFieldSettings') %}
            {% for settingKey, settingValue in fieldSettings %}
                {% if settingKey == 'indexed' or settingKey == 'Indexed' %}

                $dict["Indexed"] = {% if settingValue %}$true{% else %}$false {% endif %}

                {% elif settingKey == 'enforceUniqueValues' or settingKey == 'unique' or settingKey == 'EnforceUniqueValues' %}

                $dict["EnforceUniqueValues"] = {% if settingValue %}$true{% else %}$false {% endif %}

                {% elif settingKey == 'required' or settingKey == 'Required' %}

                $dict["Required"] = {% if settingValue %}$true{% else %}$false {% endif %}

                {% else %} 

                $dict["{{vkey}}"] = {{getPowershellValue(vvalue)}}

                {% endif %}
            {% endfor %}

            Set-PnPField -Identity "{{fieldName}}" -List "{{getAttr(list,'title')}}" -Values $dict   
        {% endfor %}
    {% endif %}
{% endfor %}

{% for command in getAttr(template,'postProvisiongCommands') %}
    
{{Command(command)}}

{% endfor %}

{% if hasAttr(template,'homePage') %}

Set-PnPHomePage -RootFolderRelativeUrl "{{getAttr(template,'homePage')}}"

{% endif %}

{% if hasAttr(template,'defaultPageLayout') %}

Set-PnPDefaultPageLayout -Title "{{getAttr(template,'defaultPageLayout')}}"

{% endif %}

{% for app in getAttr(template,'apps') %}

Import-PnPAppPackage -Path "{{getAttr(app,'path')}}" {% if getAttr(app,'force') %}-Force {% else %} -LoadOnly {% endif %} 

{% endfor %}

{% if hasAttr(template,'pages') %}
    {% for page in getAttr(template,'pages') %}

    {{AddPublishingPage(getAttr(page,'name','title'),getAttr(page,'layout','pageLayout'),getAttr(page,'title','name'),getAttr(page,'publish'),getAttr(page,'folder'),getAttr(page,'meta'))}}

    {{SetPublishingPageFields(getAttr(page,'meta'),serverRelativeUrl,getAttr(page,'name'))}}

    {% endfor %}
{% endif %}

{% if getAttr(template,'isLocalized','isLocalised') %}

Confirm-Continue -message "This site collection supportes localization, have you created the variations hierarchy in the site settings?. Press y to continue"

{% endif %}

Confirm-Continue -message "Do you want to deploy subsites?. Press y to continue"

$ctx = Get-PnPContext 

$web = $ctx.Web 

$rootWeb = Get-PnPWeb 


{% for s in template.subsites %}
    {% if getAttr(s,'parentWeb') == 'root' or getAttr(s,'parentWeb') == '/' or not hasAttr(s,'parentWeb') %}
    {{ProvisionSubSite(s)}}
    {% endif %}

{% endfor %}

{% for s in template.subsites %}
    {% if getAttr(s,'parentWeb') == 'root' or getAttr(s,'parentWeb') == '/' or not hasAttr(s,'parentWeb') %}
    {% else %}
    {{ProvisionSubSite(s)}}
    {% endif %}

{% endfor %}


# Write-Log "Disconnecting..."
Disconnect-PnPOnline